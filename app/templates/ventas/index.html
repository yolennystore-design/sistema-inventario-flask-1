{% extends "layout/base.html" %}
{% block title %}Ventas{% endblock %}

{% block content %}
<h2 class="mb-3">ğŸ›’ Ventas</h2>

<!-- ========================= FILTROS ========================= -->
<div class="card mb-3">
    <div class="card-body row g-2">
        <div class="col-md-4">
            <input type="text" id="filtroNombre" class="form-control"
                   placeholder="ğŸ” Buscar por nombre">
        </div>

        <div class="col-md-3">
            <select id="filtroCategoria" class="form-select">
                <option value="">ğŸ“‚ Todas las categorÃ­as</option>
                {% for c in categorias %}
                <option value="{{ c.nombre }}">{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <select id="filtroSubcategoria" class="form-select">
                <option value="">ğŸ“ Todas las subcategorÃ­as</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="limpiarFiltros()">ğŸ”„ Limpiar</button>
        </div>
    </div>
</div>

<!-- ========================= PRODUCTOS ========================= -->
<h4>ğŸ“¦ Productos</h4>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Agregar</th>
        </tr>
    </thead>
    <tbody>
        {% for p in productos %}
        <tr class="producto-row"
            data-nombre="{{ p.nombre|lower }}"
            data-categoria="{{ p.categoria }}"
            data-subcategoria="{{ p.subcategoria }}">
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>${{ p.precio }}</td>
            <td>
                {% if p.cantidad <= 0 %}
                <span class="badge bg-danger">AGOTADO</span>
                {% elif p.cantidad <= 5 %}
                <span class="badge bg-warning text-dark">STOCK BAJO ({{ p.cantidad }})</span>
                {% else %}
                <span class="badge bg-success">{{ p.cantidad }}</span>
                {% endif %}
            </td>
            <td>
                {% if p.cantidad > 0 %}
                <form method="POST" action="/ventas/agregar_carrito" class="d-flex">
                    <input type="hidden" name="id" value="{{ p.id }}">
                    <input type="number" name="cantidad" min="1" max="{{ p.cantidad }}"
                           class="form-control me-1" style="width:80px" required>
                    <button type="submit" class="btn btn-primary btn-sm">+</button>
                </form>
                {% else %}
                <button class="btn btn-secondary btn-sm" disabled>ğŸš«</button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ========================= CARRITO ========================= -->
<h4 class="mt-4">ğŸ§¾ Carrito</h4>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for i in carrito %}
        <tr>
            <td>{{ i.nombre }}</td>
            <td>{{ i.cantidad }}</td>
            <td>${{ i.precio }}</td>
            <td>${{ i.total }}</td>
            <td>
                <a href="/ventas/eliminar_item/{{ i.id }}"
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('Â¿Eliminar producto del carrito?')">âŒ</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5" class="text-center text-muted">ğŸ›’ Carrito vacÃ­o</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ========================= CONFIRMAR ========================= -->
<form method="POST" action="/ventas/confirmar">
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Cliente</label>
            <select name="cliente_select" class="form-select">
                <option value="PÃºblico General">PÃºblico General</option>
                {% for c in clientes %}
                <option value="{{ c.nombre }}">{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Tipo de pago</label><br>
            <input type="radio" name="tipo_venta" value="Contado" checked> Contado
            <input type="radio" name="tipo_venta" value="CrÃ©dito" class="ms-3"> CrÃ©dito
        </div>

        <div class="col-md-4" id="abonoBox" style="display:none;">
            <label class="form-label">Abono inicial</label>
            <input type="number" id="abono" name="abono"
                   class="form-control" min="0" step="0.01">
        </div>
    </div>

    <h4>Total: <strong>${{ total }}</strong></h4>
    <button class="btn btn-success">ğŸ’¾ Generar Venta</button>
</form>

<!-- ========================= SCRIPTS ========================= -->
<script>
    /* ===== ABONO DINÃMICO ===== */
    const radiosPago = document.querySelectorAll('input[name="tipo_venta"]');
    const abonoBox = document.getElementById("abonoBox");
    const abonoInput = document.getElementById("abono");

    radiosPago.forEach(r => {
        r.addEventListener("change", () => {
            if (r.value === "CrÃ©dito" && r.checked) {
                abonoBox.style.display = "block";
            } else {
                abonoBox.style.display = "none";
                abonoInput.value = "";
            }
        });
    });
</script>

<script>
/* ===== FILTROS ===== */
const categorias = {{ categorias | tojson }};
const filas = document.querySelectorAll(".producto-row");

const filtroNombre = document.getElementById("filtroNombre");
const filtroCategoria = document.getElementById("filtroCategoria");
const filtroSubcategoria = document.getElementById("filtroSubcategoria");

filtroCategoria.addEventListener("change", () => {
    filtroSubcategoria.innerHTML = "<option value=''>ğŸ“ Todas</option>";
    const cat = categorias.find(c => c.nombre === filtroCategoria.value);
    if (!cat) return;
    cat.subcategorias.forEach(s => {
        filtroSubcategoria.innerHTML += `<option>${s.nombre}</option>`;
    });
    aplicarFiltros();
});

[filtroNombre, filtroSubcategoria].forEach(el =>
    el.addEventListener("input", aplicarFiltros)
);

function aplicarFiltros() {
    const nombre = filtroNombre.value.toLowerCase();
    filas.forEach(f => {
        f.style.display = f.dataset.nombre.includes(nombre) ? "" : "none";
    });
}
</script>

{% endblock %}
