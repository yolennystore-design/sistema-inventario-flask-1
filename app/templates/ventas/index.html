{% extends "layout/base.html" %}
{% block title %}Ventas{% endblock %}

{% block content %}
<h2 class="mb-3">ğŸ›’ Ventas</h2>

<!-- =========================
     FILTRO DE PRODUCTOS
========================= -->
<div class="card mb-3">
    <div class="card-body">
        <input type="text"
               id="filtroProducto"
               class="form-control"
               placeholder="ğŸ” Buscar producto por nombre">
    </div>
</div>

<!-- ========================= PRODUCTOS ========================= -->
<h4>ğŸ“¦ Productos</h4>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Agregar</th>
        </tr>
    </thead>
    <tbody>
        {% for p in productos %}
        <tr class="producto-row" data-nombre="{{ p.nombre | lower }}">
            <td>{{ p.id }}</td>
            <td>{{ p.nombre }}</td>
            <td>${{ p.precio }}</td>
            <td>
                {% if p.cantidad <= 0 %}
                <span class="badge bg-danger">AGOTADO</span>
                {% elif p.cantidad <= 5 %}
                <span class="badge bg-warning text-dark">
                    STOCK BAJO ({{ p.cantidad }})
                </span>
                {% else %}
                <span class="badge bg-success">{{ p.cantidad }}</span>
                {% endif %}
            </td>
            <td>
                {% if p.cantidad > 0 %}
                <form method="POST" action="/ventas/agregar_carrito" class="d-flex">
                    <input type="hidden" name="id" value="{{ p.id }}">
                    <input type="number"
                           name="cantidad"
                           min="1"
                           max="{{ p.cantidad }}"
                           class="form-control me-1"
                           style="width:80px"
                           required>
                    <button type="submit" class="btn btn-primary btn-sm">+</button>
                </form>
                {% else %}
                <button class="btn btn-secondary btn-sm" disabled>ğŸš«</button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ========================= CARRITO ========================= -->
<h4 class="mt-4">ğŸ§¾ Carrito</h4>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% if carrito %}
        {% for i in carrito %}
        <tr>
            <td>{{ i.nombre }}</td>
            <td>{{ i.cantidad }}</td>
            <td>
                {% if session.rol == "admin" %}
                <form method="POST" action="/ventas/actualizar_precio" class="d-flex">
                    <input type="hidden" name="id" value="{{ i.id }}">
                    <input type="number"
                           name="precio"
                           value="{{ i.precio }}"
                           step="0.01"
                           min="0"
                           class="form-control form-control-sm me-1"
                           style="width:90px"
                           required>
                    <button class="btn btn-warning btn-sm">ğŸ’²</button>
                </form>
                {% else %}
                ${{ i.precio }}
                {% endif %}
            </td>
            <td>${{ i.total }}</td>
            <td>
                <a href="/ventas/eliminar_item/{{ i.id }}"
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('Â¿Eliminar producto del carrito?')">
                    âŒ
                </a>
            </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="5" class="text-center text-muted">
                ğŸ›’ El carrito estÃ¡ vacÃ­o
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

<!-- ========================= CONFIRMAR VENTA ========================= -->
<form method="POST" action="/ventas/confirmar" class="mt-3">
    <div class="row mb-3">

        <!-- CLIENTE -->
        <div class="col-md-4">
            <label class="form-label">Cliente</label>

            <select id="cliente_select"
                    name="cliente"
                    class="form-select">
                <option value="PÃºblico General">PÃºblico General</option>
                {% for c in clientes %}
                <option value="{{ c.nombre }}">{{ c.nombre }}</option>
                {% endfor %}
            </select>

            <button type="button"
                    class="btn btn-outline-secondary btn-sm mt-2"
                    onclick="activarClienteManual()">
                âœï¸ Cliente manual
            </button>

            <input type="text"
                   id="cliente_manual"
                   name="cliente_manual"
                   class="form-control mt-2 d-none"
                   placeholder="Nombre del cliente">
        </div>

        <!-- TIPO DE VENTA -->
        <div class="col-md-4">
            <label class="form-label">Tipo de pago</label><br>
            <input type="radio" name="tipo_venta" value="Contado" checked> Contado
            <input type="radio" name="tipo_venta" value="CrÃ©dito" class="ms-3"> CrÃ©dito
        </div>
    </div>

    <h4>Total: <strong>${{ total }}</strong></h4>

    <div class="d-flex gap-2 mt-2">
        <button type="submit"
                class="btn btn-success"
                {% if not carrito %}disabled{% endif %}>
            ğŸ’¾ Generar Venta
        </button>

        <a href="/ventas/vaciar_carrito"
           class="btn btn-secondary"
           onclick="return confirm('Â¿Cancelar la venta?')">
            âŒ Cancelar Venta
        </a>

        <a href="/" class="btn btn-outline-primary">
            â¬… Volver al Inicio
        </a>
    </div>
</form>

<hr>

<!-- ========================= VENTAS REALIZADAS ========================= -->
<h4>ğŸ–¨ Ventas Realizadas</h4>

{% if session.rol == "admin" %}
<div class="mb-3">
    <a href="/ventas/eliminar_todas"
       class="btn btn-danger"
       onclick="return confirm('âš ï¸ Esto eliminarÃ¡ TODAS las ventas y devolverÃ¡ el stock.\n\nÂ¿Continuar?')">
        ğŸ—‘ Eliminar TODAS las Ventas
    </a>
</div>
{% endif %}

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>AcciÃ³n</th>
        </tr>
    </thead>
    <tbody>
        {% for v in range(ventas|length) %}
        <tr>
            <td>{{ v + 1 }}</td>
            <td>{{ ventas[v].cliente }}</td>
            <td>
                {% if ventas[v].tipo_venta == "CrÃ©dito" %}
                <span class="badge bg-warning text-dark">CrÃ©dito</span>
                {% else %}
                <span class="badge bg-success">Contado</span>
                {% endif %}
            </td>
            <td>{{ ventas[v].fecha }}</td>
            <td><strong>${{ ventas[v].total }}</strong></td>
            <td class="d-flex gap-1">
                <a href="/ventas/factura/{{ v }}"
                   target="_blank"
                   class="btn btn-secondary btn-sm">ğŸ–¨</a>

                {% if session.rol == "admin" %}
                <a href="/ventas/eliminar/{{ v }}"
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('Â¿Eliminar esta venta?')">
                    ğŸ—‘
                </a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ========================= SCRIPTS ========================= -->
<script>
    function activarClienteManual() {
        const input = document.getElementById("cliente_manual");
        const select = document.getElementById("cliente_select");

        input.classList.toggle("d-none");

        if (!input.classList.contains("d-none")) {
            select.disabled = true;
            input.required = true;
            input.focus();
        } else {
            select.disabled = false;
            input.required = false;
            input.value = "";
        }
    }

    // ğŸ” FILTRO DE PRODUCTOS
    const filtro = document.getElementById("filtroProducto");
    const filas = document.querySelectorAll(".producto-row");

    filtro.addEventListener("input", () => {
        const texto = filtro.value.toLowerCase();

        filas.forEach(fila => {
            const nombre = fila.dataset.nombre;
            fila.style.display = nombre.includes(texto) ? "" : "none";
        });
    });
</script>

{% endblock %}
