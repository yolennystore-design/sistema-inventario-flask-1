{% extends "layout/base.html" %}
{% block title %}Productos{% endblock %}

{% block content %}
<h2 class="mb-3">üì¶ Productos</h2>

<!-- =========================
     FORMULARIO AGREGAR PRODUCTO
========================= -->
{% if session["rol"] == "admin" %}
<form method="POST"
      action="{{ url_for('productos.agregar') }}"
      enctype="multipart/form-data"
      class="row g-3 mb-4">

    <div class="col-md-3">
        <label class="form-label">Nombre</label>
        <input name="nombre" class="form-control" required>
    </div>

    <div class="col-md-2">
        <label class="form-label">Categor√≠a</label>
        <select id="categoria" name="categoria" class="form-select" required>
            <option value="">Seleccione</option>
            {% for c in categorias %}
            <option value="{{ c['nombre'] }}">{{ c['nombre'] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label class="form-label">Subcategor√≠a</label>
        <select id="subcategoria" name="subcategoria" class="form-select" required>
            <option value="">Seleccione categor√≠a</option>
        </select>
    </div>

    <div class="col-md-2">
        <label class="form-label">Tipo</label>
        <select id="item" name="item" class="form-select" required>
            <option value="">Seleccione subcategor√≠a</option>
        </select>
    </div>

    <div class="col-md-1">
        <label class="form-label">Precio</label>
        <input name="precio" type="number" step="0.01" min="0" class="form-control" required>
    </div>

    <div class="col-md-2">
        <label class="form-label">Foto</label>
        <input type="file" name="foto" class="form-control" accept="image/*">
    </div>

    <div class="col-md-12 text-end">
        <button class="btn btn-primary">Agregar producto</button>
    </div>
</form>

<hr>
{% endif %}

<!-- =========================
     TABLA DE PRODUCTOS
========================= -->
<table class="table table-striped table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Foto</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Subcategor√≠a</th>
            <th>Tipo</th>
            <th>Precio</th>
            {% if session["rol"] == "admin" %}
            <th>Acci√≥n</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for p in productos %}
        <tr>
            <td>{{ p["id"] }}</td>

            <td>
                {% if p["foto"] %}
                <img src="{{ url_for('static', filename='uploads/productos/' ~ p['foto']) }}"
                     width="50" height="50"
                     style="object-fit:cover;border-radius:6px">
                {% else %}
                ‚Äî
                {% endif %}
            </td>

            <td>{{ p["nombre"] }}</td>
            <td>{{ p["categoria"] }}</td>
            <td>{{ p["subcategoria"] }}</td>
            <td>{{ p["item"] }}</td>
            <td>${{ p["precio"] }}</td>

            {% if session["rol"] == "admin" %}
            <td>
                <a href="{{ url_for('productos.editar', id=p['id']) }}"
                   class="btn btn-sm btn-warning mb-1">
                    ‚úèÔ∏è Editar
                </a>

                <a href="{{ url_for('productos.historial', id=p['id']) }}"
                   class="btn btn-sm btn-info mb-1">
                    üßæ Historial
                </a>

                <a href="{{ url_for('productos.eliminar', id=p['id']) }}"
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('¬øEliminar producto?')">
                    üóë Eliminar
                </a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mt-3">
    ‚¨Ö Volver al Inicio
</a>

<!-- =========================
     SCRIPT CATEGOR√çAS
========================= -->
<script>
const categorias = {{ categorias | tojson }};

const categoriaSelect = document.getElementById("categoria");
const subcategoriaSelect = document.getElementById("subcategoria");
const itemSelect = document.getElementById("item");

if (categoriaSelect) {
    categoriaSelect.addEventListener("change", () => {
        subcategoriaSelect.innerHTML = "<option value=''>Seleccione</option>";
        itemSelect.innerHTML = "<option value=''>Seleccione subcategor√≠a</option>";

        const categoria = categorias.find(c => c.nombre === categoriaSelect.value);
        if (!categoria) return;

        categoria.subcategorias.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.nombre;
            opt.textContent = sub.nombre;
            subcategoriaSelect.appendChild(opt);
        });
    });
}

if (subcategoriaSelect) {
    subcategoriaSelect.addEventListener("change", () => {
        itemSelect.innerHTML = "<option value=''>Seleccione</option>";

        const categoria = categorias.find(c => c.nombre === categoriaSelect.value);
        if (!categoria) return;

        const sub = categoria.subcategorias.find(s => s.nombre === subcategoriaSelect.value);
        if (!sub) return;

        sub.items.forEach(it => {
            const opt = document.createElement("option");
            opt.value = it;
            opt.textContent = it;
            itemSelect.appendChild(opt);
        });
    });
}
</script>

{% endblock %}
